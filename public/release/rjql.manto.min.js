!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):(e=e||self,t(e.rjql={}))}(this,function(e){"use strict";function t(e,t,r){var n=!0;if(r){for(a=0;a<e.length;a++)if(e[a][r]!=t[a][r]){n=!1;break}}else for(var a=0;a<e.length;a++)if(e[a]!=t[a]){n=!1;break}return n}function r(e){var t={};for(var r of e)t[r=r.replace(/^'/,"").replace(/'$/,"")]="_";return t}function n(e,t,r,n,a){switch(a){case"=":return"Expected <i>"+t+"</i> to be <b>"+r+"</b> found <u>"+n+"</u>";case"~":return"Value <b>"+r+"</b> was not found in array <i>"+t+"</i>["+n+"]";case"<>":return"Found <i>"+t+"</i> with value <b>"+r+"</b>, while not expecting it.";default:return"Query <b>"+e+"</b> failed for value <u>"+n+"</u>"}}var a={validateRegex:function(e,t){var r=t.replace(/\$regex{\/?/,"").replace(/\/?}$/,""),n=new RegExp(r).test(e);return{result:n,verb:n?"":"<b>"+e+"</b> doesn't match the regex pattern specified"}}},s={validateSort:function(e,r){var n=e.slice(0),a=/^\$[ad]sort({(\w+)})?$/.exec(r)[1],s=/asort/.test(r);if(!n)return{result:!1,verb:"Expected an array, found "+n};if(n.length<=1)return{result:0!=n.length,verb:0==n.length?"Empty array found":""};a?"string"==typeof n[0][a]?n.sort(function(e,t){return e[a]<t[a]?s?-1:1:e[a]>t[a]?s?1:-1:0}):n.sort(function(e,t){return s?e[a]-t[a]:t[a]-e[a]}):"string"==typeof n[0]?s?n.sort():n.reverse():n.sort(function(e,t){return s?e-t:t-e});var u=t(e,n,a);return{result:u,verb:u?"":"Expected the array to be sorted in <b>"+(s?"ascending":"descending")+"</b> order "+(a?' based on property <b>"'+a+'"</b>':"")}}},u=/^[0-9a-fA-F]{8}\-[0-9a-fA-F]{4}\-[0-9a-fA-F]{4}\-[0-9a-fA-F]{4}\-[0-9a-fA-F]{12}$/,i={validateUUID:function(e){var t=u.test(e);return{result:t,verb:t?"":"Expected UUID, found "+e}}},o={validateIn:function(e,t){var n=t.replace(/^\$in{/,"").replace(/}$/,""),a=r(n.split(/,\s*/)),s=!0;e[Symbol.iterator]&&"string"!=typeof e||(e=[e]);for(var u of e)if(!a[u]){s=!1;break}return{result:s,verb:s?"":"<b>"+u+"</b> wasn't expected in {"+n+"}"}}},l=/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,c={validateIP:function(e){var t=l.test(e);return{result:t,verb:t?"":"Expected IP Address, found "+e}}},v={evaluate:function(e,t,r){if(r=function(e){return'"'===e[0]&&'"'===e[e.length-1]?e.replace(/^"/,"").replace(/"$/,""):e}(r),"="===t)return e==r;if("<>"===t)return e!=r;if("~"===t)return e.indexOf(r)>=0;switch(r=Number(r),e=Number(e),t){case">":return e>r;case">=":return e>=r;case"<":return e<r;case"<=":return e<=r}}};const f=v.evaluate;var d={count:function(e,t){var r,n=0,a=/^\$(count|max|min|avg|sum)\{(.+)\}\s(=|<|>|<=|>=)\s(.+)/.exec(e),s=a[2],u=s.indexOf(":");if(u>=0){var i=s.substr(0,u).trim(),o=s.substr(u+1).trim().replace(/^\//,"").replace(/\/$/,"");r=new RegExp(o),s=i}for(var l of t){var c=l[s];c&&(r?r.test(c)&&n++:n++)}var v=f(n,a[3],a[4]);return{value:n,status:v,verb:v?"":"Count "+n+" didn't match the expected count "+a[4]}}};const p=v.evaluate;var g={sum:function(e,t){var r=/^\$(count|max|min|avg|sum)\{(.+)\}\s(=|<|>|<=|>=)\s(.+)/.exec(e),n=r[2],a=0;for(var s of t){var u=s[n];if(u){try{u=Number(u)}catch(e){}a+=u}}var i=p(a,r[3],r[4]);return{value:a,status:i,verb:i?"":"Sum "+a+" didn't match the expected sum "+r[4]}}};const b=v.evaluate,x=g.sum;var h={avg:function(e,t){var r=/^\$(count|max|min|avg|sum)\{(.+)\}\s(=|<|>|<=|>=)\s(.+)/.exec(e),n=x(e,t).value/t.length,a=b(n,r[3],r[4]);return{value:n,status:a,verb:a?"":"Avg "+n+" didn't match the expected avg "+r[4]}}};const m=v.evaluate;var y={min:function(e,t){var r=/^\$(count|max|min|avg|sum)\{(.+)\}\s(=|<|>|<=|>=)\s(.+)/.exec(e),n=r[2],a=Number.MAX_SAFE_INTEGER;for(var s of t){var u=s[n];if(u){try{u=Number(u)}catch(e){}a>u&&(a=u)}}var i=m(a,r[3],r[4]);return{value:a,status:i,verb:i?"":"Minimum value "+a+" didn't match the expected min "+r[4]}}};const N=v.evaluate;var $={max:function(e,t){var r=/^\$(count|max|min|avg|sum)\{(.+)\}\s(=|<|>|<=|>=)\s(.+)/.exec(e),n=r[2],a=Number.MIN_SAFE_INTEGER;for(var s of t){var u=s[n];if(u){try{u=Number(u)}catch(e){}a<u&&(a=u)}}var i=N(a,r[3],r[4]);return{value:a,status:i,verb:i?"":"Maximum value "+a+" didn't match the expected max "+r[4]}}};const E=a.validateRegex,w=s.validateSort,L=i.validateUUID,A=o.validateIn,q=c.validateIP,I=d.count,R=h.avg,S=y.min,F=$.max,O=g.sum;var P={getQEValidator:function(e){var t=/^(\$[a-z]+){?/;if(!t.test(e))return null;switch(t.exec(e)[1]){case"$uuid":return L;case"$asort":case"$dsort":return w;case"$regex":return E;case"$in":return A;case"$ip":return q;default:return null}},getAggregationFunction:function(e){var t=/^\$(count|max|min|avg|sum)/.exec(e);if(null==t)return null;switch(t[1]){case"count":return I;case"avg":return R;case"min":return S;case"max":return F;case"sum":return O;default:return null}},getEmptyResult:function(){return{errLineNo:-1,verb:"",passed:!0,next:"",target:void 0}},traverse:function(e,t){try{for(var r of t)if(r){var n=/\[(\d+)?\]$/.exec(r);null==n?e=e[r]:(e=e[r=r.replace(n[0],"")],void 0!=n[1]&&(e=e[parseInt(n[1])]))}return e}catch(e){return}}};const _=P.getEmptyResult;var k={consolidateResults:function(e,t){var r=[],n={total:e.length,passed:0},a=[],s=e[0],u=0;for(var i of e){var o=function(e,r,n){return e.passed&&n.passed++,{queryBlock:r+1,status:e.passed,verb:e.verb,line:e.errLineNo,linesToHighlight:function(e){if(!e)return{start:-1,end:-1};var r=JSON.stringify(e,null," ").replace(/\n\s+/g,"\n"),n=JSON.stringify(t,null," ").replace(/\n\s+/g,"\n"),a=n.indexOf(r),s=n.substr(0,a).split("\n").length;return{start:s,end:s-1+r.split("\n").length}}(e.target)}}(i,u,n);r.push(o),a.push({start:o.linesToHighlight.start,end:o.linesToHighlight.end,passed:o.status}),s=function(e,t){var r=_();if("&&"==e.next)r.passed=e.passed&&t.passed,r.verb=e.passed?t.verb:e.verb,r.errLineNo=e.passed?t.errLineNo:e.errLineNo,r.next=t.next;else{if("||"!=e.next)return e;r.passed=e.passed||t.passed,r.verb=e.passed?t.verb:e.verb,r.errLineNo=e.passed?t.errLineNo:e.errLineNo,r.next=t.next}return r}(s,i),u++}return s.qbs=r,s.overAll=n,s.highlights=a,s}},J={getQueryProcessor:function(e){var t=e.split(/\n/),r=0;return{query:function(){if(r<t.length)do{var e=t[r].trim();if(0!=e.length)return e;r++}while(r<t.length);return null},next:function(){r++},hasNext:function(){return r<t.length},getLineNo:function(){return r+1}}}};const Q=v.evaluate,T=P.getQEValidator,U=P.traverse;var M={evaluateExpression:function(e,t,r,a){var s=/\s+([=~<>]+)\s+/.exec(e.q)[1],u=e.q.split(/\s+[=~<>]+\s+/),i=U(t,u[0].split(">")),o=function(e){return e.replace(/^"/,"").replace(/"$/,"")}(u[1]),l=T(o),c=l?l(i,o):Q(i,s,o),v="boolean"==typeof c?c:c.result;if(v||(i?r.verb="boolean"!=typeof c?c.verb:n(e.q,u[0],o,i,s):(v=!1,r.verb="Property <b>"+u[0]+"</b> doesn't exist."),r.errLineNo=a.getLineNo()),r.operator=s,r.passed=v,v||"<>"===s){for(var f=t,d=u[0].split(">"),p=0;p<d.length-1;p++)f=f[d[p]];r.target=f,r.errLineNo=a.getLineNo()}return v}};const j=P.getAggregationFunction,D=P.getEmptyResult,H=k.consolidateResults,V=J.getQueryProcessor,G=M.evaluateExpression,z=P.traverse;var B=function(e,t){function r(e,t,u){var i=t.query();if(null!=i&&!s){if("&&"===i||"||"===i)return u.next=i,t.next(),void(s=!0);var o=a(i);if("E"!=o.what)if(e=z(e,o.q.split(">")),"N"==o.what)t.next(),r(e,t,u);else if(e&&e[Symbol.iterator]&&"string"!=typeof e){t.next();var l=j(t.query());if(l)n(l,t,e,u);else{for(var c of e)if(r(c,t,u)){u.target=c;break}c||(t.next(),r(c,t,u))}}else u.verb="Expected an array found "+typeof e,u.passed=!1,u.errLineNo=t.getLineNo();else G(o,e,u,t)&&(t.next(),r(e,t,u))}}function n(e,t,n,a){var s=e(t.query(),n);s.status?(a.target=n,t.next(),r(n,t,a)):(a.passed=s.status,a.verb=s.verb,a.errLineNo=t.getLineNo())}function a(e){var t={};return/:$/.test(e)?(t.what="N",/\[\]:$/.test(e)&&(t.what="A"),e=e.replace(/(\[\])?:$/,"")):t.what="E",t.q=e,t}var s=!1,u=[],i=V(t),o=D();if(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(e){console.log(e),o.verb="The response is not a valid JSON. <b>RJQL</b> works only for JSON. ",o.passed=!1}if(""==o.verb)do{s=!1;var l=D();if(u.push(l),r(e,i,l),""===l.next){i.next();var c=function(e){for(;e.hasNext();){var t=e.query();if(e.next(),t&&"&&||".indexOf(t)>=0)return t}return null}(i);null!=c&&(l.next=c)}}while(""!=l.next)}return 0===u.length&&u.push(o),H(u,e)},C={validate:B};e.default=C,e.validate=B,Object.defineProperty(e,"__esModule",{value:!0})});
